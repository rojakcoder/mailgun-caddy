package mailgun

import (
	"fmt"
	"os"
	"regexp"
	"strings"
)

const emailSeparator = ","

// fileExists returns true if file exists
func fileExists(path string) bool {
	fi, err := os.Stat(path)
	return !os.IsNotExist(err) && fi.Size() > 0
}

// tempDir returns temporary directory ending with a path separatoe
//func tempDir() string {
//	dir := os.TempDir()
//	const ps = string(os.PathSeparator)
//	if len(dir) > 0 && dir[len(dir)-1:] != ps {
//		dir = dir + ps
//	}
//	return dir
//}

const emailRegexString = "^(?:(?:(?:(?:[a-zA-Z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])+(?:\\.([a-zA-Z]|\\d|[!#\\$%&'\\*\\+\\-\\/=\\?\\^_`{\\|}~]|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])+)*)|(?:(?:\\x22)(?:(?:(?:(?:\\x20|\\x09)*(?:\\x0d\\x0a))?(?:\\x20|\\x09)+)?(?:(?:[\\x01-\\x08\\x0b\\x0c\\x0e-\\x1f\\x7f]|\\x21|[\\x23-\\x5b]|[\\x5d-\\x7e]|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])|(?:\\(?:[\\x01-\\x09\\x0b\\x0c\\x0d-\\x7f]|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}]))))*(?:(?:(?:\\x20|\\x09)*(?:\\x0d\\x0a))?(\\x20|\\x09)+)?(?:\\x22)))@(?:(?:(?:[a-zA-Z]|\\d|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])|(?:(?:[a-zA-Z]|\\d|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])(?:[a-zA-Z]|\\d|-|\\.|_|~|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])*(?:[a-zA-Z]|\\d|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])))\\.)+(?:(?:[a-zA-Z]|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])|(?:(?:[a-zA-Z]|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])(?:[a-zA-Z]|\\d|-|\\.|_|~|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])*(?:[a-zA-Z]|[\\x{00A0}-\\x{D7FF}\\x{F900}-\\x{FDCF}\\x{FDF0}-\\x{FFEF}])))\\.?$"

var emailRegex = regexp.MustCompile(emailRegexString)

func isValidEmail(email string) bool {
	return emailRegex.MatchString(email)
}

// deleteEntrySS removes on entry from a string slice
func deleteEntrySS(sl []string, toDelete string) []string {
	var ret = make([]string, 0, len(sl))
	for _, s := range sl {
		if s != toDelete {
			ret = append(ret, s)
		}
	}
	return ret
}

func loadFromEnv(s string) string {
	const envPrefix = `ENV:`
	if strings.Index(s, envPrefix) != 0 {
		return s
	}
	return os.Getenv(s[len(envPrefix):])
}

func splitEmails(s string) ([]string, error) {
	emails := strings.Split(s, emailSeparator)
	for i, v := range emails {
		emails[i] = strings.TrimSpace(v)
		if !isValidEmail(emails[i]) {
			return nil, fmt.Errorf("[mailgun] Invalid email address %q", emails[i])
		}
	}
	return emails, nil
}
